<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.miracleyoo.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.15.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Estimator, Experiment, and Dataset的关系">
<meta property="og:type" content="article">
<meta property="og:title" content="TensorFlow Higher-Level APIs的使用">
<meta property="og:url" content="https://www.miracleyoo.com/2019/01/05/tf-high-level-api/index.html">
<meta property="og:site_name" content="Miracleyoo">
<meta property="og:description" content="Estimator, Experiment, and Dataset的关系">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.miracleyoo.com/2019/01/05/tf-high-level-api/1*zoNZvvuJb06yAghetc6BfQ.png">
<meta property="article:published_time" content="2019-01-06T00:22:16.000Z">
<meta property="article:modified_time" content="2021-03-12T09:12:44.559Z">
<meta property="article:author" content="Miracle Yoo">
<meta property="article:tag" content="machine-learning">
<meta property="article:tag" content="deep-learning">
<meta property="article:tag" content="tensorflow">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.miracleyoo.com/2019/01/05/tf-high-level-api/1*zoNZvvuJb06yAghetc6BfQ.png">


<link rel="canonical" href="https://www.miracleyoo.com/2019/01/05/tf-high-level-api/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.miracleyoo.com/2019/01/05/tf-high-level-api/","path":"2019/01/05/tf-high-level-api/","title":"TensorFlow Higher-Level APIs的使用"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>TensorFlow Higher-Level APIs的使用 | Miracleyoo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Miracleyoo" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Miracleyoo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#estimator"><span class="nav-number">1.</span> <span class="nav-text"> Estimator, Experiment, and Dataset的关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#estimator%E5%AE%9A%E4%B9%89"><span class="nav-number">2.</span> <span class="nav-text"> Estimator定义</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E9%87%8A"><span class="nav-number">2.1.</span> <span class="nav-text"> 参数解释</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#model-function"><span class="nav-number">2.1.1.</span> <span class="nav-text"> Model function</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#estimator%E5%88%9B%E5%BB%BA%E6%96%B9%E5%BC%8F"><span class="nav-number">3.</span> <span class="nav-text"> Estimator创建方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E4%BB%8E-keras-%E6%A8%A1%E5%9E%8B%E5%88%9B%E5%BB%BA-estimator%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="nav-number">3.1.</span> <span class="nav-text"> 3从 Keras 模型创建 Estimator的例子：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%99%E6%A0%B7%E5%81%9A%E7%9A%84%E5%A5%BD%E5%A4%84"><span class="nav-number">3.2.</span> <span class="nav-text"> 这样做的好处</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#estimator-%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="nav-number">4.</span> <span class="nav-text"> Estimator 的优势</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E6%84%8F%E4%B9%89%E8%A7%92%E5%BA%A6"><span class="nav-number">4.1.</span> <span class="nav-text"> 从意义角度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E4%BD%BF%E7%94%A8%E8%A7%92%E5%BA%A6"><span class="nav-number">4.2.</span> <span class="nav-text"> 从使用角度</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A2%84%E5%88%9B%E5%BB%BA%E7%9A%84-estimator-%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%BB%93%E6%9E%84"><span class="nav-number">5.</span> <span class="nav-text"> 预创建的 Estimator 程序的结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#experiment"><span class="nav-number">6.</span> <span class="nav-text"> Experiment</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dataset"><span class="nav-number">6.1.</span> <span class="nav-text"> Dataset</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E7%94%A8"><span class="nav-number">7.</span> <span class="nav-text"> 引用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="nav-number">8.</span> <span class="nav-text"> 示例代码</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Miracle Yoo</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">132</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">114</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/miracleyoo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;miracleyoo" rel="noopener me" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhongyang.zhang.hust@gmail.com" title="E-Mail → mailto:zhongyang.zhang.hust@gmail.com" rel="noopener me" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/Ogisomiracle" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;Ogisomiracle" rel="noopener me" target="_blank"><i class="twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/mirakuruyoo" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;mirakuruyoo" rel="noopener me" target="_blank"><i class="facebook fa-fw"></i>FB Page</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
        <div class="pjax">
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.miracleyoo.com/2019/01/05/tf-high-level-api/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Miracle Yoo">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Miracleyoo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="TensorFlow Higher-Level APIs的使用 | Miracleyoo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          TensorFlow Higher-Level APIs的使用<a href="https://github.com/user-name/repo-name/tree/branch-name/subdirectory-name/_posts/tf-high-level-api.md" class="post-edit-link" title="Edit this post" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-01-05 16:22:16" itemprop="dateCreated datePublished" datetime="2019-01-05T16:22:16-08:00">2019-01-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2021-03-12 01:12:44" itemprop="dateModified" datetime="2021-03-12T01:12:44-08:00">2021-03-12</time>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>3.4k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>12 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="estimator"><a class="markdownIt-Anchor" href="#estimator"></a> <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/estimator/Estimator">Estimator</a>, <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/contrib/learn/Experiment">Experiment</a>, and <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/contrib/data/Dataset">Dataset</a>的关系</h2>
<p><img data-src="1*zoNZvvuJb06yAghetc6BfQ.png" alt="Overview of the Experiment, Estimator and DataSet framework and how they interact. (These components will be explained in the following sections)"></p>
<span id="more"></span>
<h2 id="estimator定义"><a class="markdownIt-Anchor" href="#estimator定义"></a> Estimator定义</h2>
<p>The <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/estimator/Estimator"><strong>Estimator</strong></a> class represents a model, as well as how this model should be trained and evaluated. We can create an estimator as follows:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> tf.estimator.Estimator(</span><br><span class="line">    model_fn=model_fn,  <span class="comment"># First-class function</span></span><br><span class="line">    params=params,  <span class="comment"># HParams</span></span><br><span class="line">    config=run_config  <span class="comment"># RunConfig</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="参数解释"><a class="markdownIt-Anchor" href="#参数解释"></a> 参数解释</h3>
<p>To create the Estimator we need to pass in a model function, a collection of parameters and some configuration.</p>
<ul>
<li>The <strong>parameters</strong> should be a collection of the model’s hyperparameters. This can be a dictionary, but we will represent it in this example as an <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/contrib/training/HParams">HParams</a> object, which acts as a <a target="_blank" rel="noopener" href="https://docs.python.org/2/library/collections.html#collections.namedtuple">namedtuple</a>.</li>
<li>The <strong>configuration</strong> specifies how the <strong>training and evaluation</strong> are run, and where to store the results. This configuration will be represented by a <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/contrib/learn/RunConfig">RunConfig</a> object, which communicates everything the Estimator needs to know about the environment in which the model will be run.</li>
<li>The <strong>model function</strong> is a Python function, which builds the model given the input. (More on this later)</li>
</ul>
<h4 id="model-function"><a class="markdownIt-Anchor" href="#model-function"></a> Model function</h4>
<p>The model function is a Python function which is passed as a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/First-class_function">first-class function</a> to the Estimator. We’ll see later that TensorFlow uses first-class functions in other places. The benefit of representing the model as a function is that the model can be recreated over and over by instantiating the function. The model can be recreated during the training with different input, for example, to run validation tests during training.</p>
<p>The model function takes the <strong>input features</strong> as parameters and the corresponding <strong>labels</strong> as tensors. It also takes a <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/contrib/learn/ModeKeys"><strong>mode</strong></a> that signals if the model is training, evaluating or performing inference. The last parameter to the model function should be a collection of <strong>hyperparameters</strong>, which are the same as those passed to the Estimator. This model function should return an <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/estimator/EstimatorSpec"><strong>EstimatorSpec</strong></a> object which will define the complete model.</p>
<p>The EstimatorSpec takes in the prediction, loss, training and evaluation <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/Operation">Operations</a> so it defines the full model graph used for training, evaluation, and inference. Because the EstimatorSpec just takes in regular TensorFlow Operations, we can use frameworks like <a target="_blank" rel="noopener" href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/contrib/slim">TF-Slim</a> to define our model.</p>
<h2 id="estimator创建方式"><a class="markdownIt-Anchor" href="#estimator创建方式"></a> Estimator创建方式</h2>
<ol>
<li>预创建的 Estimator</li>
<li>自定义 Estimator</li>
<li>从 Keras 模型创建 Estimator</li>
</ol>
<h3 id="3从-keras-模型创建-estimator的例子"><a class="markdownIt-Anchor" href="#3从-keras-模型创建-estimator的例子"></a> 3从 Keras 模型创建 Estimator的例子：</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Instantiate a Keras inception v3 model.</span></span><br><span class="line">keras_inception_v3 = tf.keras.applications.inception_v3.InceptionV3(weights=<span class="literal">None</span>)</span><br><span class="line"><span class="comment"># Compile model with the optimizer, loss, and metrics you&#x27;d like to train with.</span></span><br><span class="line">keras_inception_v3.<span class="built_in">compile</span>(optimizer=tf.keras.optimizers.SGD(lr=<span class="number">0.0001</span>, momentum=<span class="number">0.9</span>),</span><br><span class="line">                          loss=<span class="string">&#x27;categorical_crossentropy&#x27;</span>,</span><br><span class="line">                          metric=<span class="string">&#x27;accuracy&#x27;</span>)</span><br><span class="line"><span class="comment"># Create an Estimator from the compiled Keras model. Note the initial model</span></span><br><span class="line"><span class="comment"># state of the keras model is preserved in the created Estimator.</span></span><br><span class="line">est_inception_v3 = tf.keras.estimator.model_to_estimator(keras_model=keras_inception_v3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Treat the derived Estimator as you would with any other Estimator.</span></span><br><span class="line"><span class="comment"># First, recover the input name(s) of Keras model, so we can use them as the</span></span><br><span class="line"><span class="comment"># feature column name(s) of the Estimator input function:</span></span><br><span class="line">keras_inception_v3.input_names  <span class="comment"># print out: [&#x27;input_1&#x27;]</span></span><br><span class="line"><span class="comment"># Once we have the input name(s), we can create the input function, for example,</span></span><br><span class="line"><span class="comment"># for input(s) in the format of numpy ndarray:</span></span><br><span class="line">train_input_fn = tf.estimator.inputs.numpy_input_fn(</span><br><span class="line">    x=&#123;<span class="string">&quot;input_1&quot;</span>: train_data&#125;,</span><br><span class="line">    y=train_labels,</span><br><span class="line">    num_epochs=<span class="number">1</span>,</span><br><span class="line">    shuffle=<span class="literal">False</span>)</span><br><span class="line"><span class="comment"># To train, we call Estimator&#x27;s train function:</span></span><br><span class="line">est_inception_v3.train(input_fn=train_input_fn, steps=<span class="number">2000</span>)</span><br></pre></td></tr></table></figure>
<h3 id="这样做的好处"><a class="markdownIt-Anchor" href="#这样做的好处"></a> 这样做的好处</h3>
<p>Keras 模型本身容易建立，导出到Estimator后又可以利用 Estimator 的优势，例如分布式训练。</p>
<h2 id="estimator-的优势"><a class="markdownIt-Anchor" href="#estimator-的优势"></a> Estimator 的优势</h2>
<h3 id="从意义角度"><a class="markdownIt-Anchor" href="#从意义角度"></a> 从意义角度</h3>
<ul>
<li>环境适配性好。可以在本地主机、分布式多服务器环境中运行基于 Estimator 的模型，而无需更改模型。此外，可以在 CPU、GPU 或 TPU 上运行基于 Estimator 的模型，而无需重新编码模型。</li>
<li>简化了在模型开发者之间共享实现的过程。</li>
<li>采用 Estimator 创建模型通常比采用低阶 TensorFlow API 更简单。</li>
<li>其本身在 <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/layers?hl=zh-cn"><code>tf.layers</code></a> 之上构建而成，可以简化自定义过程。</li>
<li>Estimator 会自动构建图。</li>
<li>Estimator 提供安全的分布式训练循环，可以控制如何以及何时：
<ul>
<li>构建图</li>
<li>初始化变量</li>
<li>开始排队</li>
<li>处理异常</li>
<li>创建检查点文件并从故障中恢复</li>
<li>保存 TensorBoard 的摘要</li>
</ul>
</li>
</ul>
<h3 id="从使用角度"><a class="markdownIt-Anchor" href="#从使用角度"></a> 从使用角度</h3>
<ul>
<li><strong>学习流程</strong>：Estimator 封装了对机器学习不同阶段的控制，用户无需不断的为新机器学习任务重复编写训练、评估、预测的代码。可以专注于对网络结构的控制。</li>
<li><strong>网络结构</strong>：Estimator 的网络结构是在 model_fn 中独立定义的，用户创建的任何网络结构都可以在 Estimator 的控制下进行机器学习。这可以允许用户很方便的使用别人定义好的 model_fn。</li>
<li><strong>数据导入</strong>：Estimator 的数据导入也是由 input_fn 独立定义的。例如，用户可以非常方便的只通过改变 input_fn 的定义，来使用相同的网络结构学习不同的数据。</li>
</ul>
<p>使用 Estimator 编写应用时，您必须将数据输入管道从模型中分离出来。这种分离简化了不同数据集的实验流程。</p>
<h2 id="预创建的-estimator-程序的结构"><a class="markdownIt-Anchor" href="#预创建的-estimator-程序的结构"></a> 预创建的 Estimator 程序的结构</h2>
<p>依赖预创建的 Estimator 的 TensorFlow 程序通常包含下列四个步骤：</p>
<ol>
<li>
<p><strong>编写一个或多个数据集导入函数。</strong> 例如，您可以创建一个函数来导入训练集，并创建另一个函数来导入测试集。每个数据集导入函数都必须返回两个对象：</p>
<ul>
<li>一个字典，其中键是特征名称，值是包含相应特征数据的张量（或 SparseTensor）</li>
<li>一个包含一个或多个标签的张量</li>
</ul>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">input_fn</span>(<span class="params">dataset</span>):</span><br><span class="line">   ...  <span class="comment"># manipulate dataset, extracting the feature dict and the label</span></span><br><span class="line">   <span class="keyword">return</span> feature_dict, label</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><strong>定义特征列。</strong> 每个 <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/feature_column?hl=zh-cn"><code>tf.feature_column</code></a> 都标识了特征名称、特征类型和任何输入预处理操作。例如，以下代码段创建了三个存储整数或浮点数据的特征列。前两个特征列仅标识了特征的名称和类型。第三个特征列还指定了一个 lambda，该程序将调用此 lambda 来调节原始数据：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Define three numeric feature columns.</span></span><br><span class="line">population = tf.feature_column.numeric_column(<span class="string">&#x27;population&#x27;</span>)</span><br><span class="line">crime_rate = tf.feature_column.numeric_column(<span class="string">&#x27;crime_rate&#x27;</span>)</span><br><span class="line">median_education = tf.feature_column.numeric_column(<span class="string">&#x27;median_education&#x27;</span>,</span><br><span class="line">                    normalizer_fn=<span class="keyword">lambda</span> x: x - global_education_mean)</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><strong>实例化相关的预创建的 Estimator。</strong> 例如，下面是对名为 <code>LinearClassifier</code> 的预创建 Estimator 进行实例化的示例代码：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Instantiate an estimator, passing the feature columns.</span></span><br><span class="line">estimator = tf.estimator.LinearClassifier(</span><br><span class="line">    feature_columns=[population, crime_rate, median_education],</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>**调用训练、评估或推理方法。**例如，所有 Estimator 都提供训练模型的 <code>train</code> 方法。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my_training_set is the function created in Step 1 estimator.train(input_fn=my_training_set, steps=2000)</span></span><br></pre></td></tr></table></figure>
<h2 id="experiment"><a class="markdownIt-Anchor" href="#experiment"></a> Experiment</h2>
<p>The <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/contrib/learn/Experiment"><strong>Experiment</strong></a> class defines how to train a model and integrates nicely with the Estimator. We can create an experiment as follows:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">experiment = tf.contrib.learn.Experiment(</span><br><span class="line">    estimator=estimator,  <span class="comment"># Estimator</span></span><br><span class="line">    train_input_fn=train_input_fn,  <span class="comment"># First-class function</span></span><br><span class="line">    eval_input_fn=eval_input_fn,  <span class="comment"># First-class function</span></span><br><span class="line">    train_steps=params.train_steps,  <span class="comment"># Minibatch steps</span></span><br><span class="line">    min_eval_frequency=params.min_eval_frequency,  <span class="comment"># Eval frequency</span></span><br><span class="line">    train_monitors=[train_input_hook],  <span class="comment"># Hooks for training</span></span><br><span class="line">    eval_hooks=[eval_input_hook],  <span class="comment"># Hooks for evaluation</span></span><br><span class="line">    eval_steps=<span class="literal">None</span>  <span class="comment"># Use evaluation feeder until its empty</span></span><br><span class="line">)</span><br><span class="line">view raw</span><br></pre></td></tr></table></figure>
<p>The Experiment takes as input:</p>
<ul>
<li>An <strong>estimator</strong> (for example the one we defined above).</li>
<li><strong>Train and evaluation data</strong> as a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/First-class_function">first-class function</a>. The same concept as the model function explained earlier is used here. By passing in a function instead of operation, the input graph can be recreated if needed. We’ll talk more about this later.</li>
<li><a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_guides/python/train#Training_Hooks"><strong>Training and Evaluating hooks</strong></a>. These hooks can be used to save or monitor specific things, or to set up certain operations in the Graph or Session. For example, we will be passing in operations to help initialize the data loaders (again, more later).</li>
<li>Various parameters describing how long to train for and when to evaluate.</li>
</ul>
<p>Once we have defined the experiment, we can run it to train and evaluate the model with <a target="_blank" rel="noopener" href="http://tf.contrib.learn.learn_runner.run/">learn_runner.run</a> as follows:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">learn_runner.run(</span><br><span class="line">    experiment_fn=experiment_fn,  <span class="comment"># First-class function</span></span><br><span class="line">    run_config=run_config,  <span class="comment"># RunConfig</span></span><br><span class="line">    schedule=<span class="string">&quot;train_and_evaluate&quot;</span>,  <span class="comment"># What to run</span></span><br><span class="line">    hparams=params  <span class="comment"># HParams</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>Like the model function and the data functions, the learn runner takes in the function that creates the experiment as a parameter.</p>
<h3 id="dataset"><a class="markdownIt-Anchor" href="#dataset"></a> Dataset</h3>
<p>We’ll be using the <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/contrib/data/Dataset"><strong>Dataset</strong></a> class and the corresponding <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/contrib/data/Iterator"><strong>Iterator</strong></a> to represent our training and evaluation data, and to create data feeders that iterate over the data during training. In this example, we will use the <a target="_blank" rel="noopener" href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/examples/tutorials/mnist">MNIST</a> data that’s available in Tensorflow, and build a Dataset wrapper around it. For example, we will represent the training input data as:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Define the training inputs</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_train_inputs</span>(<span class="params">batch_size, mnist_data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Return the input function to get the training data.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        batch_size (int): Batch size of training iterator that is returned</span></span><br><span class="line"><span class="string">                          by the input function.</span></span><br><span class="line"><span class="string">        mnist_data (Object): Object holding the loaded mnist data.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        (Input function, IteratorInitializerHook):</span></span><br><span class="line"><span class="string">            - Function that returns (features, labels) when called.</span></span><br><span class="line"><span class="string">            - Hook to initialise input iterator.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    iterator_initializer_hook = IteratorInitializerHook()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">train_inputs</span>():</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Returns training set as Operations.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            (features, labels) Operations that iterate over the dataset</span></span><br><span class="line"><span class="string">            on every evaluation</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> tf.name_scope(<span class="string">&#x27;Training_data&#x27;</span>):</span><br><span class="line">            <span class="comment"># Get Mnist data</span></span><br><span class="line">            images = mnist_data.train.images.reshape([-<span class="number">1</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>])</span><br><span class="line">            labels = mnist_data.train.labels</span><br><span class="line">            <span class="comment"># Define placeholders</span></span><br><span class="line">            images_placeholder = tf.placeholder(</span><br><span class="line">                images.dtype, images.shape)</span><br><span class="line">            labels_placeholder = tf.placeholder(</span><br><span class="line">                labels.dtype, labels.shape)</span><br><span class="line">            <span class="comment"># Build dataset iterator</span></span><br><span class="line">            dataset = tf.contrib.data.Dataset.from_tensor_slices(</span><br><span class="line">                (images_placeholder, labels_placeholder))</span><br><span class="line">            dataset = dataset.repeat(<span class="literal">None</span>)  <span class="comment"># Infinite iterations</span></span><br><span class="line">            dataset = dataset.shuffle(buffer_size=<span class="number">10000</span>)</span><br><span class="line">            dataset = dataset.batch(batch_size)</span><br><span class="line">            iterator = dataset.make_initializable_iterator()</span><br><span class="line">            next_example, next_label = iterator.get_next()</span><br><span class="line">            <span class="comment"># Set runhook to initialize iterator</span></span><br><span class="line">            iterator_initializer_hook.iterator_initializer_func = \</span><br><span class="line">                <span class="keyword">lambda</span> sess: sess.run(</span><br><span class="line">                    iterator.initializer,</span><br><span class="line">                    feed_dict=&#123;images_placeholder: images,</span><br><span class="line">                               labels_placeholder: labels&#125;)</span><br><span class="line">            <span class="comment"># Return batched (features, labels)</span></span><br><span class="line">            <span class="keyword">return</span> next_example, next_label</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Return function and hook</span></span><br><span class="line">    <span class="keyword">return</span> train_inputs, iterator_initializer_hook</span><br></pre></td></tr></table></figure>
<p>Calling this <em>get_train_inputs</em> will return a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/First-class_function">first-class function</a> that creates the data loading operations in a TensorFlow graph, together with a Hook to initialize the iterator.</p>
<p>The MNIST data used in this example is initially represented as a <a target="_blank" rel="noopener" href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.ndarray.html">Numpy array</a>. We create a <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/placeholder">placeholder</a> tensor that gets the data fed in; we use a placeholder in order to avoid copying the data. Next, we create a sliced dataset with the help of <em>from_tensor_slices.</em> We will make sure that this dataset runs for an infinite amount of epochs (the experiment can take care of limiting the number of epochs), and that the data gets shuffled and put into batches of the required size.</p>
<p>To iterate over the data we need to create an iterator from the dataset. Because we are using a placeholder we need to initialize the placeholder in the relevant session with the NumPy data. We can do this by creating an <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/contrib/data/Dataset#make_initializable_iterator">initializable iterator</a>. We will create a custom defined _IteratorInitializerHook _object to initialize the iterator when the graph is created:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IteratorInitializerHook</span>(tf.train.SessionRunHook):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Hook to initialise data iterator after Session is created.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(IteratorInitializerHook, self).__init__()</span><br><span class="line">        self.iterator_initializer_func = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">after_create_session</span>(<span class="params">self, session, coord</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Initialise the iterator after the session has been created.&quot;&quot;&quot;</span></span><br><span class="line">        self.iterator_initializer_func(session)</span><br></pre></td></tr></table></figure>
<p>The <em>IteratorInitializerHook</em> inherits from <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/train/SessionRunHook"><strong>SessionRunHook</strong></a>. This hook will call <em>after_create_session</em> as soon as the relevant session is created, and initialize the placeholder with the right data. This hook is returned by our <em>get_train_inputs</em> function and will be passed to the Experiment object upon creation.</p>
<p>The data loading operations returned by the <em>train_inputs</em> function are TensorFlow <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/Operation">operations</a> that will return a new batch every time they are evaluated.</p>
<h2 id="引用"><a class="markdownIt-Anchor" href="#引用"></a> 引用</h2>
<ol>
<li><a target="_blank" rel="noopener" href="https://medium.com/onfido-tech/higher-level-apis-in-tensorflow-67bfb602e6c0">Higher-Level APIs in TensorFlow</a></li>
<li><a target="_blank" rel="noopener" href="https://www.tensorflow.org/guide/estimators?hl=zh-cn">TensorFlow Estimator</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/59b4cc816fb9a00a6974c5a3">如何使用TensorFlow中的高级API：Estimator、Experiment和Dataset</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/33681224">TensorFlow高层API：Custom Estimator建立CNN+RNN</a></li>
<li>There is a paper called <a target="_blank" rel="noopener" href="https://terrytangyuan.github.io/data/papers/tf-estimators-kdd-paper.pdf">“TensorFlow Estimators: Managing Simplicity vs. Flexibility in High-Level Machine Learning Frameworks”</a> describing the high level-design of the Estimator framework.</li>
<li><a target="_blank" rel="noopener" href="https://www.tensorflow.org/versions/r1.3/programmers_guide/datasets">TensorFlow has more documentation on using the Dataset API</a>.</li>
<li>There are 2 versions of the Estimator class. We are using the one at <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/estimator/Estimator">tf.estimator.Estimator</a> in this example, but there is also an older unstable version at <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/contrib/learn/Estimator">tf.contrib.learn.Estimator</a>.</li>
<li>There are also 2 versions of the RunConfig class. While we are using the one at <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/contrib/learn/RunConfig">tf.contrib.learn.RunConfig</a> there is also a version at <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/estimator/RunConfig">tf.estimator.RunConfig</a>. I couldn’t get the latter one to work with the Experiment framework so I stuck with the tf.contrib version.</li>
<li>While we didn’t use them in this example, the Estimator framework defines predefined estimators for typical models such as <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/estimator/DNNClassifier">classifiers</a> and <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/estimator/DNNRegressor">regressors</a>. These predefined estimators are easy to use and come with a <a target="_blank" rel="noopener" href="https://www.tensorflow.org/extend/estimators">detailed tutorial</a>.</li>
<li>TensorFlow also defines an abstraction for the “head” of a model, the part that sits on top of the architecture and defines the loss, evaluation and training operations. This head will take care of things like defining the model function, and all the required Operations. You can find a version at <a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/contrib/learn/Head">tf.contrib.learn.Head</a>. There is also a <a target="_blank" rel="noopener" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/estimator/canned/head.py">prototype version</a> in the newer estimator framework. We decided not to use it in this example due to its development being quite unstable.</li>
<li>This blog uses the TensorFlow <a target="_blank" rel="noopener" href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/contrib/slim">slim</a> framework to define the architecture of the model. Slim is a lightweight library for defining complex models in tensorflow. They also define <a target="_blank" rel="noopener" href="https://github.com/tensorflow/models/tree/master/slim">pre-defined architectures and pre-trained models</a>.</li>
</ol>
<h2 id="示例代码"><a class="markdownIt-Anchor" href="#示例代码"></a> 示例代码</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;Script to illustrate usage of tf.estimator.Estimator in TF v1.3&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tensorflow.examples.tutorials.mnist <span class="keyword">import</span> input_data <span class="keyword">as</span> mnist_data</span><br><span class="line"><span class="keyword">from</span> tensorflow.contrib <span class="keyword">import</span> slim</span><br><span class="line"><span class="keyword">from</span> tensorflow.contrib.learn <span class="keyword">import</span> ModeKeys</span><br><span class="line"><span class="keyword">from</span> tensorflow.contrib.learn <span class="keyword">import</span> learn_runner</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Show debugging output</span></span><br><span class="line">tf.logging.set_verbosity(tf.logging.DEBUG)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set default flags for the output directories</span></span><br><span class="line">FLAGS = tf.app.flags.FLAGS</span><br><span class="line">tf.app.flags.DEFINE_string(</span><br><span class="line">    flag_name=<span class="string">&#x27;model_dir&#x27;</span>, default_value=<span class="string">&#x27;./mnist_training&#x27;</span>,</span><br><span class="line">    docstring=<span class="string">&#x27;Output directory for model and training stats.&#x27;</span>)</span><br><span class="line">tf.app.flags.DEFINE_string(</span><br><span class="line">    flag_name=<span class="string">&#x27;data_dir&#x27;</span>, default_value=<span class="string">&#x27;./mnist_data&#x27;</span>,</span><br><span class="line">    docstring=<span class="string">&#x27;Directory to download the data to.&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define and run experiment ###############################</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_experiment</span>(<span class="params">argv=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Run the training experiment.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Define model parameters</span></span><br><span class="line">    params = tf.contrib.training.HParams(</span><br><span class="line">        learning_rate=<span class="number">0.002</span>,</span><br><span class="line">        n_classes=<span class="number">10</span>,</span><br><span class="line">        train_steps=<span class="number">5000</span>,</span><br><span class="line">        min_eval_frequency=<span class="number">100</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Set the run_config and the directory to save the model and stats</span></span><br><span class="line">    run_config = tf.contrib.learn.RunConfig()</span><br><span class="line">    run_config = run_config.replace(model_dir=FLAGS.model_dir)</span><br><span class="line"></span><br><span class="line">    learn_runner.run(</span><br><span class="line">        experiment_fn=experiment_fn,  <span class="comment"># First-class function</span></span><br><span class="line">        run_config=run_config,  <span class="comment"># RunConfig</span></span><br><span class="line">        schedule=<span class="string">&quot;train_and_evaluate&quot;</span>,  <span class="comment"># What to run</span></span><br><span class="line">        hparams=params  <span class="comment"># HParams</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">experiment_fn</span>(<span class="params">run_config, params</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Create an experiment to train and evaluate the model.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        run_config (RunConfig): Configuration for Estimator run.</span></span><br><span class="line"><span class="string">        params (HParam): Hyperparameters</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        (Experiment) Experiment for training the mnist model.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># You can change a subset of the run_config properties as</span></span><br><span class="line">    run_config = run_config.replace(</span><br><span class="line">        save_checkpoints_steps=params.min_eval_frequency)</span><br><span class="line">    <span class="comment"># Define the mnist classifier</span></span><br><span class="line">    estimator = get_estimator(run_config, params)</span><br><span class="line">    <span class="comment"># Setup data loaders</span></span><br><span class="line">    mnist = mnist_data.read_data_sets(FLAGS.data_dir, one_hot=<span class="literal">False</span>)</span><br><span class="line">    train_input_fn, train_input_hook = get_train_inputs(</span><br><span class="line">        batch_size=<span class="number">128</span>, mnist_data=mnist)</span><br><span class="line">    eval_input_fn, eval_input_hook = get_test_inputs(</span><br><span class="line">        batch_size=<span class="number">128</span>, mnist_data=mnist)</span><br><span class="line">    <span class="comment"># Define the experiment</span></span><br><span class="line">    experiment = tf.contrib.learn.Experiment(</span><br><span class="line">        estimator=estimator,  <span class="comment"># Estimator</span></span><br><span class="line">        train_input_fn=train_input_fn,  <span class="comment"># First-class function</span></span><br><span class="line">        eval_input_fn=eval_input_fn,  <span class="comment"># First-class function</span></span><br><span class="line">        train_steps=params.train_steps,  <span class="comment"># Minibatch steps</span></span><br><span class="line">        min_eval_frequency=params.min_eval_frequency,  <span class="comment"># Eval frequency</span></span><br><span class="line">        train_monitors=[train_input_hook],  <span class="comment"># Hooks for training</span></span><br><span class="line">        eval_hooks=[eval_input_hook],  <span class="comment"># Hooks for evaluation</span></span><br><span class="line">        eval_steps=<span class="literal">None</span>  <span class="comment"># Use evaluation feeder until its empty</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> experiment</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define model ############################################</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_estimator</span>(<span class="params">run_config, params</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Return the model as a Tensorflow Estimator object.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">         run_config (RunConfig): Configuration for Estimator run.</span></span><br><span class="line"><span class="string">         params (HParams): hyperparameters.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> tf.estimator.Estimator(</span><br><span class="line">        model_fn=model_fn,  <span class="comment"># First-class function</span></span><br><span class="line">        params=params,  <span class="comment"># HParams</span></span><br><span class="line">        config=run_config  <span class="comment"># RunConfig</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">model_fn</span>(<span class="params">features, labels, mode, params</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Model function used in the estimator.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        features (Tensor): Input features to the model.</span></span><br><span class="line"><span class="string">        labels (Tensor): Labels tensor for training and evaluation.</span></span><br><span class="line"><span class="string">        mode (ModeKeys): Specifies if training, evaluation or prediction.</span></span><br><span class="line"><span class="string">        params (HParams): hyperparameters.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        (EstimatorSpec): Model to be run by Estimator.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    is_training = mode == ModeKeys.TRAIN</span><br><span class="line">    <span class="comment"># Define model&#x27;s architecture</span></span><br><span class="line">    logits = architecture(features, is_training=is_training)</span><br><span class="line">    predictions = tf.argmax(logits, axis=-<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># Loss, training and eval operations are not needed during inference.</span></span><br><span class="line">    loss = <span class="literal">None</span></span><br><span class="line">    train_op = <span class="literal">None</span></span><br><span class="line">    eval_metric_ops = &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> mode != ModeKeys.INFER:</span><br><span class="line">        loss = tf.losses.sparse_softmax_cross_entropy(</span><br><span class="line">            labels=tf.cast(labels, tf.int32),</span><br><span class="line">            logits=logits)</span><br><span class="line">        train_op = get_train_op_fn(loss, params)</span><br><span class="line">        eval_metric_ops = get_eval_metric_ops(labels, predictions)</span><br><span class="line">    <span class="keyword">return</span> tf.estimator.EstimatorSpec(</span><br><span class="line">        mode=mode,</span><br><span class="line">        predictions=predictions,</span><br><span class="line">        loss=loss,</span><br><span class="line">        train_op=train_op,</span><br><span class="line">        eval_metric_ops=eval_metric_ops</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_train_op_fn</span>(<span class="params">loss, params</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Get the training Op.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">         loss (Tensor): Scalar Tensor that represents the loss function.</span></span><br><span class="line"><span class="string">         params (HParams): Hyperparameters (needs to have `learning_rate`)</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        Training Op</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> tf.contrib.layers.optimize_loss(</span><br><span class="line">        loss=loss,</span><br><span class="line">        global_step=tf.contrib.framework.get_global_step(),</span><br><span class="line">        optimizer=tf.train.AdamOptimizer,</span><br><span class="line">        learning_rate=params.learning_rate</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_eval_metric_ops</span>(<span class="params">labels, predictions</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Return a dict of the evaluation Ops.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        labels (Tensor): Labels tensor for training and evaluation.</span></span><br><span class="line"><span class="string">        predictions (Tensor): Predictions Tensor.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        Dict of metric results keyed by name.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;Accuracy&#x27;</span>: tf.metrics.accuracy(</span><br><span class="line">            labels=labels,</span><br><span class="line">            predictions=predictions,</span><br><span class="line">            name=<span class="string">&#x27;accuracy&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">architecture</span>(<span class="params">inputs, is_training, scope=<span class="string">&#x27;MnistConvNet&#x27;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Return the output operation following the network architecture.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        inputs (Tensor): Input Tensor</span></span><br><span class="line"><span class="string">        is_training (bool): True iff in training mode</span></span><br><span class="line"><span class="string">        scope (str): Name of the scope of the architecture</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">         Logits output Op for the network.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> tf.variable_scope(scope):</span><br><span class="line">        <span class="keyword">with</span> slim.arg_scope(</span><br><span class="line">                [slim.conv2d, slim.fully_connected],</span><br><span class="line">                weights_initializer=tf.contrib.layers.xavier_initializer()):</span><br><span class="line">            net = slim.conv2d(inputs, <span class="number">20</span>, [<span class="number">5</span>, <span class="number">5</span>], padding=<span class="string">&#x27;VALID&#x27;</span>,</span><br><span class="line">                              scope=<span class="string">&#x27;conv1&#x27;</span>)</span><br><span class="line">            net = slim.max_pool2d(net, <span class="number">2</span>, stride=<span class="number">2</span>, scope=<span class="string">&#x27;pool2&#x27;</span>)</span><br><span class="line">            net = slim.conv2d(net, <span class="number">40</span>, [<span class="number">5</span>, <span class="number">5</span>], padding=<span class="string">&#x27;VALID&#x27;</span>,</span><br><span class="line">                              scope=<span class="string">&#x27;conv3&#x27;</span>)</span><br><span class="line">            net = slim.max_pool2d(net, <span class="number">2</span>, stride=<span class="number">2</span>, scope=<span class="string">&#x27;pool4&#x27;</span>)</span><br><span class="line">            net = tf.reshape(net, [-<span class="number">1</span>, <span class="number">4</span> * <span class="number">4</span> * <span class="number">40</span>])</span><br><span class="line">            net = slim.fully_connected(net, <span class="number">256</span>, scope=<span class="string">&#x27;fn5&#x27;</span>)</span><br><span class="line">            net = slim.dropout(net, is_training=is_training,</span><br><span class="line">                               scope=<span class="string">&#x27;dropout5&#x27;</span>)</span><br><span class="line">            net = slim.fully_connected(net, <span class="number">256</span>, scope=<span class="string">&#x27;fn6&#x27;</span>)</span><br><span class="line">            net = slim.dropout(net, is_training=is_training,</span><br><span class="line">                               scope=<span class="string">&#x27;dropout6&#x27;</span>)</span><br><span class="line">            net = slim.fully_connected(net, <span class="number">10</span>, scope=<span class="string">&#x27;output&#x27;</span>,</span><br><span class="line">                                       activation_fn=<span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">return</span> net</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define data loaders #####################################</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IteratorInitializerHook</span>(tf.train.SessionRunHook):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Hook to initialise data iterator after Session is created.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(IteratorInitializerHook, self).__init__()</span><br><span class="line">        self.iterator_initializer_func = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">after_create_session</span>(<span class="params">self, session, coord</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Initialise the iterator after the session has been created.&quot;&quot;&quot;</span></span><br><span class="line">        self.iterator_initializer_func(session)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define the training inputs</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_train_inputs</span>(<span class="params">batch_size, mnist_data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Return the input function to get the training data.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        batch_size (int): Batch size of training iterator that is returned</span></span><br><span class="line"><span class="string">                          by the input function.</span></span><br><span class="line"><span class="string">        mnist_data (Object): Object holding the loaded mnist data.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        (Input function, IteratorInitializerHook):</span></span><br><span class="line"><span class="string">            - Function that returns (features, labels) when called.</span></span><br><span class="line"><span class="string">            - Hook to initialise input iterator.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    iterator_initializer_hook = IteratorInitializerHook()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">train_inputs</span>():</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Returns training set as Operations.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            (features, labels) Operations that iterate over the dataset</span></span><br><span class="line"><span class="string">            on every evaluation</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> tf.name_scope(<span class="string">&#x27;Training_data&#x27;</span>):</span><br><span class="line">            <span class="comment"># Get Mnist data</span></span><br><span class="line">            images = mnist_data.train.images.reshape([-<span class="number">1</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>])</span><br><span class="line">            labels = mnist_data.train.labels</span><br><span class="line">            <span class="comment"># Define placeholders</span></span><br><span class="line">            images_placeholder = tf.placeholder(</span><br><span class="line">                images.dtype, images.shape)</span><br><span class="line">            labels_placeholder = tf.placeholder(</span><br><span class="line">                labels.dtype, labels.shape)</span><br><span class="line">            <span class="comment"># Build dataset iterator</span></span><br><span class="line">            dataset = tf.contrib.data.Dataset.from_tensor_slices(</span><br><span class="line">                (images_placeholder, labels_placeholder))</span><br><span class="line">            dataset = dataset.repeat(<span class="literal">None</span>)  <span class="comment"># Infinite iterations</span></span><br><span class="line">            dataset = dataset.shuffle(buffer_size=<span class="number">10000</span>)</span><br><span class="line">            dataset = dataset.batch(batch_size)</span><br><span class="line">            iterator = dataset.make_initializable_iterator()</span><br><span class="line">            next_example, next_label = iterator.get_next()</span><br><span class="line">            <span class="comment"># Set runhook to initialize iterator</span></span><br><span class="line">            iterator_initializer_hook.iterator_initializer_func = \</span><br><span class="line">                <span class="keyword">lambda</span> sess: sess.run(</span><br><span class="line">                    iterator.initializer,</span><br><span class="line">                    feed_dict=&#123;images_placeholder: images,</span><br><span class="line">                               labels_placeholder: labels&#125;)</span><br><span class="line">            <span class="comment"># Return batched (features, labels)</span></span><br><span class="line">            <span class="keyword">return</span> next_example, next_label</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Return function and hook</span></span><br><span class="line">    <span class="keyword">return</span> train_inputs, iterator_initializer_hook</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_test_inputs</span>(<span class="params">batch_size, mnist_data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Return the input function to get the test data.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        batch_size (int): Batch size of training iterator that is returned</span></span><br><span class="line"><span class="string">                          by the input function.</span></span><br><span class="line"><span class="string">        mnist_data (Object): Object holding the loaded mnist data.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        (Input function, IteratorInitializerHook):</span></span><br><span class="line"><span class="string">            - Function that returns (features, labels) when called.</span></span><br><span class="line"><span class="string">            - Hook to initialise input iterator.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    iterator_initializer_hook = IteratorInitializerHook()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_inputs</span>():</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Returns training set as Operations.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            (features, labels) Operations that iterate over the dataset</span></span><br><span class="line"><span class="string">            on every evaluation</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> tf.name_scope(<span class="string">&#x27;Test_data&#x27;</span>):</span><br><span class="line">            <span class="comment"># Get Mnist data</span></span><br><span class="line">            images = mnist_data.test.images.reshape([-<span class="number">1</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>])</span><br><span class="line">            labels = mnist_data.test.labels</span><br><span class="line">            <span class="comment"># Define placeholders</span></span><br><span class="line">            images_placeholder = tf.placeholder(</span><br><span class="line">                images.dtype, images.shape)</span><br><span class="line">            labels_placeholder = tf.placeholder(</span><br><span class="line">                labels.dtype, labels.shape)</span><br><span class="line">            <span class="comment"># Build dataset iterator</span></span><br><span class="line">            dataset = tf.contrib.data.Dataset.from_tensor_slices(</span><br><span class="line">                (images_placeholder, labels_placeholder))</span><br><span class="line">            dataset = dataset.batch(batch_size)</span><br><span class="line">            iterator = dataset.make_initializable_iterator()</span><br><span class="line">            next_example, next_label = iterator.get_next()</span><br><span class="line">            <span class="comment"># Set runhook to initialize iterator</span></span><br><span class="line">            iterator_initializer_hook.iterator_initializer_func = \</span><br><span class="line">                <span class="keyword">lambda</span> sess: sess.run(</span><br><span class="line">                    iterator.initializer,</span><br><span class="line">                    feed_dict=&#123;images_placeholder: images,</span><br><span class="line">                               labels_placeholder: labels&#125;)</span><br><span class="line">            <span class="keyword">return</span> next_example, next_label</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Return function and hook</span></span><br><span class="line">    <span class="keyword">return</span> test_inputs, iterator_initializer_hook</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run script ##############################################</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    tf.app.run(</span><br><span class="line">        main=run_experiment</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="followme">
  <span>Welcome to my other publishing channels</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://www.zhihu.com/people/miracleyoo">
            <span class="icon">
              <i class="fab fa-zhihu"></i>
            </span>

            <span class="label">Zhihu</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/machine-learning/" rel="tag"># machine-learning</a>
              <a href="/tags/deep-learning/" rel="tag"># deep-learning</a>
              <a href="/tags/tensorflow/" rel="tag"># tensorflow</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2018/12/12/get-resource/" rel="prev" title="Quick Tutorial on how to find e-books, movies and musics">
                  <i class="fa fa-chevron-left"></i> Quick Tutorial on how to find e-books, movies and musics
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/01/19/rl-basic/" rel="next" title="强化学习基础">
                  强化学习基础 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Miracle Yoo</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">181k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">10:58</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/miracleyoo" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/katex.min.css" integrity="sha256-gMRN4/6qeELzO1wbFa8qQLU8kfuF2dnAPiUoI0ATjx8=" crossorigin="anonymous">


<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"miracleyoo/utterances-repo","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
